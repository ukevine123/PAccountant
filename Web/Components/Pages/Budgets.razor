@page "/Budgets"


@using Application.Services.Budgets
@using Domain.Entities

@inject IBudgetService BudgetService
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>Budgets</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudCard>
        <MudCardHeader>
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width: 100%;">
                <MudText Typo="Typo.h5">Budgets</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => OpenDialog())">Add Budget</MudButton>
            </MudStack>
        </MudCardHeader>
        <MudCardContent>
            <MudDataGrid T="Budget" MultiSelection="true" Items="@_budgets" SortMode="SortMode.Multiple" 
                         Filterable="true" QuickFilter="@_quickFilter" Hideable="true" 
                         RowClick="@RowClicked" SelectedItemsChanged="@SelectedItemsChanged">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Budgets Overview</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchString" Placeholder="Search budgets..." Adornment="Adornment.Start" 
                                  Immediate="true" AdornmentIcon="@Icons.Material.Filled.Search" 
                                  IconSize="Size.Medium" Class="mt-0"></MudTextField>
                </ToolBarContent>
                <Columns>
                    <SelectColumn T="Budget" />
                    <PropertyColumn Property="x => x.CategoryId" Title="ID" Sortable="true" Filterable="true" />
                    <PropertyColumn Property="x => x.Name" Title="Budget Name" Sortable="true" Filterable="true" />
                    <PropertyColumn Property="x => x.MonthlyLimit" Title="Allocated Amount" Sortable="true" Filterable="false" 
                                    Format="C" />
                    <TemplateColumn Title="Actions" Sortable="false" Filterable="false">
                        <CellTemplate>
                            <MudButton Variant="Variant.Text" Color="Color.Info" Size="Size.Small" 
                                       Href="@($"/Budgets/{context.Item.CategoryId}")">View</MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Warning" Size="Size.Small" 
                                       Href="@($"/Budgets/edit/{context.Item.CategoryId}")">Edit</MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small" 
                                       OnClick="@(() => DeleteBudget(context.Item.Id))">
                                <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                            </MudButton>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="Budget" />
                </PagerContent>
            </MudDataGrid>

            <MudExpansionPanels Style="flex:1" Class="mt-4">
                <MudExpansionPanel Text="@($"Selected Budgets ({_selectedItems.Count})")">
                    @if (_selectedItems.Count > 0)
                    {
                        <MudText Typo="Typo.body2" Class="mb-3"><strong>Total Allocation:</strong> @GetSelectedTotal().ToString("C")</MudText>
                        @foreach (var item in _selectedItems)
                        {
                            <MudChip T="Budget" Color="Color.Primary" OnClose="@(() => _selectedItems.Remove(item))">
                                @item.Name - @item.MonthlyLimit .ToString("C")
                            </MudChip>
                        }
                        <div class="d-flex mt-3">
                            <MudSpacer/>
                            <MudButton Class="mt-3" ButtonType="ButtonType.Button" Variant="Variant.Filled" 
                                       OnClick="@(() => _selectedItems.Clear())">Clear Selection</MudButton>
                        </div>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2">No budgets selected</MudText>
                    }
                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code 
{
    private List<Budget> _budgets = new();
    private string _searchString = string.Empty;
    private HashSet<Budget> _selectedItems = new();

    protected override void OnInitialized()
    {
        _budgets = BudgetService.GetAllBudgets();
    }

    private Func<Budget, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if ($"{x.CategoryId}".Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (!string.IsNullOrEmpty(x.Name) && x.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if ($"{x.MonthlyLimit}".Contains(_searchString))
            return true;

        return false;
    };

    void RowClicked(DataGridRowClickEventArgs<Budget> args)
    {
        // Navigation or quick-view logic can go here
    }

    void SelectedItemsChanged(HashSet<Budget> items)
    {
        _selectedItems = items;
    }

    decimal GetSelectedTotal()
    {
        return _selectedItems.Sum(b => b.MonthlyLimit);
    }

    private async Task OpenDialog()
    {
        // Note: You will need to create a BudgetDialog component
        var dialog = await DialogService.ShowAsync<CreateBudget>("Add New Budget");
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            _budgets = BudgetService.GetAllBudgets();
        }
    }

    void DeleteBudget(int id)
    {
        // Implementation for deletion
        _budgets = _budgets.Where(b => b.CategoryId != id).ToList();
    }
}
@page "/Assets"
@using Application.Interfaces
@using Domain.Entities
@inject IAssetService AssetService
@inject IDialogService DialogService

<PageTitle>Assets</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h5">Assets</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreateDialog">
                        Add Asset
                    </MudButton>
                </MudStack>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudDataGrid Items="@_assets" T="Asset">
                <Columns>
                    <PropertyColumn Property="x => x.Id" Title="ID" />
                    <PropertyColumn Property="x => x.Name" />
                    <PropertyColumn Property="x => x.Type" />
                    <PropertyColumn Property="x => x.Value" Format="C" />
                    <TemplateColumn Title="Actions">
                        <CellTemplate>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteAsset(context.Item.Id))" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private List<Asset> _assets = new();

    // Use OnInitializedAsync for async data loading
    protected override async Task OnInitializedAsync() 
    {
        await LoadData();
    }

    private async Task LoadData() 
    { 
        _assets = await AssetService.GetAllAssetsAsync(); 
        // Calling StateHasChanged inside the data load ensures the UI re-renders 
        // once the data actually arrives.
        StateHasChanged(); 
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AssetCreateDialog>("Create Asset", options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            // CRITICAL FIX: You must await LoadData so the code waits for 
            // the database response before trying to update the UI.
            await LoadData(); 
        }
    }

    private async Task DeleteAsset(int id)
    {
        // Assuming your service has a delete method:
        // await AssetService.DeleteAssetAsync(id);
        
        await LoadData(); // Refresh list from DB after delete
    }
}
}
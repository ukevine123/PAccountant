@page "/Liabilities"
@using Domain.Entities
@using Application.Interface
@using Application.DTO

@inject ILiabilityService LiabilityService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Liabilities - PAccountant</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudText Typo="Typo.h4"><b>Liabilities</b></MudText>
        <MudButton Variant="Variant.Filled" 
                   StartIcon="@Icons.Material.Filled.Add" 
                   Color="Color.Primary" 
                   OnClick="@(() => OpenCreateDialog())">
            Add Liability
        </MudButton>
    </MudStack>

    <MudTable Items="@liabilities" Hover="true" Striped="true" Loading="@isLoading" Elevation="2">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Type</MudTh>
            <MudTh>Value</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Type">@context.Type</MudTd>
            <MudTd DataLabel="Value">@context.Value.ToString("C")</MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                               Color="Color.Info" 
                               Size="Size.Small" 
                               Href="@($"/Liabilities/edit/{context.Id}")" />
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                               Color="Color.Default" 
                               Size="Size.Small" 
                               Href="@($"/Liabilities/{context.Id}")" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No liabilities found.</MudText>
        </NoRecordsContent>
    </MudTable>
</MudContainer>

@code {
    private IEnumerable<Liability> liabilities = new List<Liability>();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        // Updated to use the Async version of your service
        liabilities = await LiabilityService.GetAllLiabilitiesAsync();
        isLoading = false;
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<LiabilityDialog>("New Liability", options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadData();
        }
    }
}
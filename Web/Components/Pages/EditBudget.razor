@page "/Budgets/Edit/{Id:int}"

@using Application.Services.Budgets
@using Domain.Entities
@using Application.DTO.Budget

@inject IBudgetService BudgetService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Edit Budget</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudPaper Elevation="4" Class="pa-6">
        <MudStack Spacing="4">
            <MudText Typo="Typo.h5" Color="Color.Warning">Edit Budget: @_model.Name</MudText>
            <MudText Typo="Typo.body2" Class="mb-4">Update the details for this budget category below.</MudText>

            @if (_loading)
            {
                <MudProgressLinear Color="Color.Info" Indeterminate="true" Class="my-7" />
            }
            else
            {
                <MudForm @ref="_form" @bind-IsValid="@_success">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudTextField T="string" 
                                          Label="Budget Name" 
                                          @bind-Value="_model.Name" 
                                          Required="true" 
                                          RequiredError="Budget name is required!" 
                                          Variant="Variant.Outlined" 
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Label" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudNumericField T="decimal" 
                                            Label="Monthly Limit" 
                                            @bind-Value="_model.MonthlyLimit" 
                                            Format="C" 
                                            Required="true" 
                                            Min="0.01m" 
                                            Variant="Variant.Outlined" 
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                             <MudTextField T="int" 
                                          Label="Category ID" 
                                          @bind-Value="_model.CategoryId" 
                                          ReadOnly="true"
                                          Variant="Variant.Outlined" 
                                          HelperText="Category ID cannot be changed" />
                        </MudItem>

                        <MudItem xs="12" Class="d-flex justify-end gap-4 mt-4">
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Secondary" 
                                       OnClick="Cancel">Cancel</MudButton>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Warning" 
                                       Disabled="@(!_success)" 
                                       OnClick="Submit">Update Budget</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudForm>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public int Id { get; set; }

    private MudForm _form = default!;
    private bool _success;
    private bool _loading = true;
    private BudgetUpdateDTO _model = new();

    protected override void OnInitialized()
    {
        try
        {
            // Fetch the existing budget by ID
            var result = BudgetService.GetBudgetById(Id);
          
            
                Snackbar.Add("Budget not found.", Severity.Error);
                Navigation.NavigateTo("/Budgets");
            
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading budget: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/Budgets");
    }

    private void  Submit()
    {
        @* await _form.Validate(); *@

        if (_form.IsValid)
        {
            try 
            {
                // Note: Ensure your service has an Update method
                BudgetService.UpdateBudget(Id, _model);
                
                Snackbar.Add("Budget updated successfully!", Severity.Success);
                Navigation.NavigateTo("/Budgets");
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }
}